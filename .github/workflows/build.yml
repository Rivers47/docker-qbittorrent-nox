# action.yml
name: "Build image"
on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
    paths-ignore:
      - '**/Readme.md'
  workflow_dispatch:

env:
  IMAGE_NAME: "qbittorrent-macvlan"
  IMAGE_REGISTRY: "ghcr.io/${{ github.repository_owner }}"  # do not edit
  QBT_VERSION: "5.1.3"
  LIBBT_VERSION: "RC_2.0"
jobs:
  build:
    name: Build image
    runs-on: ubuntu-latest
    strategy:
      matrix:
        LIBT: ["RC_2.0", "RC_1.2"]
    steps:
    - name: Prepare environment
      run: |
        # Lowercase the image uri
        echo "IMAGE_REGISTRY=${IMAGE_REGISTRY,,}" >> ${GITHUB_ENV}
        echo "IMAGE_NAME=${IMAGE_NAME,,}" >> ${GITHUB_ENV}
    - uses: actions/checkout@v5
    - name: Image Metadata
      uses: docker/metadata-action@v5
      id: metadata
      with:
        labels: |
          org.opencontainers.image.source=https://github.com/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}/blob/main/Containerfile
          org.opencontainers.image.title=${{ env.IMAGE_NAME }}
    - name: Buildah Action
      uses: redhat-actions/buildah-build@v2
      with:
        image: ${{env.IMAGE_NAME}}
        tags: ${{env.QBT_VERSION}}-${{matrix.LIBT}}
        containerfiles: |
          ./Containerfile
        build-args: |
          QBT_VERSION=${{env.QBT_VERSION}}
          LIBBT_VERSION=${{matrix.LIBT\/\.\/\/}}
        oci: true

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      if: github.event_name != 'pull_request' && github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Push To GHCR
      uses: redhat-actions/push-to-registry@v2
      if: github.event_name != 'pull_request' && github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
      id: push
      env:
        REGISTRY_USER: ${{ github.actor }}
        REGISTRY_PASSWORD: ${{ github.token }}
      with:
        registry: ${{ env.IMAGE_REGISTRY }}
        image: ${{ env.IMAGE_NAME }}
        tags: ${{env.QBT_VERSION}}-${{matrix.LIBT}}
        username: ${{ env.REGISTRY_USER }}
        password: ${{ env.REGISTRY_PASSWORD }}
